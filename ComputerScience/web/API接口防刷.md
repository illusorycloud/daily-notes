# API接口防刷

## 1. 概述

在项目上线后，后台接口很容易通过抓包工具看到， 难免被人为构造恶意请求攻击我们的系统，相信大家都或多或少都遇到过短信验证码被刷、疯狂留言灌水、数据被恶意爬取等问题，这种直接抓接口然后写个循环调用的行为门槛极低，本文重点提供一种提高安全门槛的方法供大家参考。

安全问题是长期的和攻击者斗智斗勇的问题，没有一劳永逸的解决方案，不断交锋，不断成。



## 2. 常见攻击手段

常见攻击手机包括以下几种

* 1）伪造请求（重放攻击）
  * 唯一参数
* 2）篡改参数（篡改攻击）
  * 签名机制
* 3）DDos

> 第三点已经超过了API接口的范畴，本文不进行重点讨论。



### 1. 重放攻击

所谓重放攻击就是攻击者发送一个目的主机已接收过的包，来达到欺骗系统的目的，主要用于身份认证过程，重放攻击是计算机世界黑客常用的攻击方式之一。

> 简单说就是把参数原封不动的复制过来在发起一次新的请求。

**解决方案：timestamp + nonce**

请求时带上时间戳和唯一字符串nonce。

服务端先校验 timestamp，如果已经超过限制时间（比如60s），则认定该请求为异常请求。

如果 timestamp通过则校验nonce是否已经使用过。

> 使用redis或其他存储记录下每次请求的nonce（由于timestamp的存在只需要记录60s即可），后续请求时如果已经在该记录中则说明是异常请求。



### 2. 篡改攻击

使用签名可以很好的防止篡改攻击。

* 1）客户端使用约定好的秘钥对传输参数进行加密，得到签名值signature，并且将签名值也放入请求参数中，发送请求给服务端；
* 2）服务端接收客户端的请求，然后使用约定好的秘钥对请求的参数（除了signature以外）再次进行签名，得到签名值autograph；
* 3）服务端对比signature和autograph的值，如果对比一致，认定为合法请求。如果对比不一致，说明参数被篡改，认定为非法请求；



因为攻击者不知道签名的秘钥，所以即使截取到请求数据，对请求参数进行篡改，但是却无法对参数进行签名，无法得到修改后参数的签名值signature。
签名的秘钥我们可以使用很多方案，可以采用对称加密或者非对称加密。



## 3. Web 服务

Web 服务由于所有代码都在前端可以直接看到，破解是比较轻松的。

比如:

 `重放攻击` 中的 timestamp + nonce 都是前端生成，攻击者看一下源码很容易就能知道具体生成逻辑。

`篡改攻击`中的 签名算法 写在前端攻击者肯定也是能通过源码分析出来的。

然后依旧通过服务端自己写一套相同的逻辑疯狂提交。

所以说：安全问题是长期的和攻击者斗智斗勇的问题，没有一劳永逸的解决方案，不断交锋，不断成。





## 4. 常见防治手段

通常情况下的api接口防护有如下几种：

- 使用HTTPS防止抓包，使用https至少会给破解者在抓包的时候提高一些难度
- 接口参数的加解密，通过md5加密数据+时间戳+随机字符串（salt），然后将MD5加密的数据和时间戳、原数据均传到后台，后台规定一个有效时长，如果在该时长内，且解密后的数据与原数据一致，则认为是正常请求；也可以采用aes/des之类的加密算法，还可以加入客户端的本地信息作为判断依据
- 本地加密混淆，以上提到的加解密数据和算法，不要直接放在本地代码，因为很容易被反编译和破解，建议放到独立模块中去，并且函数名称越混淆越难读越安全。
- User-Agent 和 Referer 限制
- api防护的登录验证，包括设备验证和用户验证，可以通过检查session等方式来判断用户是否登录
- api的访问次数限制，限制其每分钟的api调用次数，可以通过session或者ip来做限制
- 定期监测，检查日志，侦查异常的接口访问

