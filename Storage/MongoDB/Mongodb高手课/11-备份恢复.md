# MongoDB备份与恢复

## 1.概述

备份的目的：

* 防止硬件故障引起的数据丢失
* 防止人为错误误删数据
* 时间回溯
* 监管要求

第一点MongoDB生产集群已经通过复制集的多节点实现，不会存在数据丢失问题。本讲的备份主要是为其他几个目的。

MongoDB的备份机制分为:

* 延迟节点备份
* 全量备份+ Oplog增量

最常见的全量备份方式包括：

* mongodump;
* 复制数据文件;
* 文件系统快照;



## 2. 延迟节点备份

通过设置从节点与主节点指定一定的延迟时间，作为延迟节点存在。

用于保护认为误操作。

误操作删除数据后，主节点上数据立刻被删除了，然后同步到从节点导致从节点上的数据也会被删除。

延迟节点由于和主节点存在一定延迟，这期间就可以从延迟节点上找回数据。



## 3. 全量备份加oplog

* 最近的oplog已经在oplog.rs集合中，因此可以在定期从集合中导出便得到了oplog;
* 如果主节点上的oplog.rs集合足够大,全量备份足够密集,自然也可以不用备份oplog;
* 只要有覆盖整个时间段的oplog,就可以结合全量备份得到任意时间点的备份。



### 注意事项

**复制文件全量备份**

复制数据库文件:

* 必须先关闭节点才能复制，否则复制到的文件无效; .
* 也可以选择db.fsyncL .ock()锁定节点,但完成后不要忘记db.fsyncUnlock()解锁;
* 可以且应该在从节点上完成;
* 该方法实际 上会暂时宕机-个从节点,所以整个过程中应注意投票节点总数。

**文件系统快照**:

* MongoDB支持使用文件系统快照 直接获取数据文件在某- -时刻的镜像;
* 快照过程中可以不用停机;
* 数据文件和Journal必须在同一个卷上;
* 快照完成后请尽快复制文件并删除快照;

**mongodump**:

* 使用mongodump备份最灵活,但速度上也是最慢的;
* mongodump出来的数据不能表示某个个时间点，只是某个时间段。
  * dump完成需要一定时间，从第0条数据到第n条数据。
  * 第0条数据dump下来后，在dump后续数据的时候第0条数据被修改了
  * 此时由于数据0已结被dump下来的，所以不会被更新到dump文件中

正常打开方式为：使用dump数据恢复后，还需要把dump期间的oplog重放一次，保证所有数据都是最新的。





## 4. 实例

几个重要参数:
mongodump

* --oplog:复制mongodump开始到结束过程中的所有oplog并输出到结果中。输出文件位于dump/oplog.bson

mongorestore

* --oplogReplay: 恢复完数据文件后再重放oplog。默认重放dump/ oplog.bson=> `<dump-directory>/local/ oplog.rs.bson`。如果oplog不在这，则可以:
  * --oplogFile:指定需要重放的oplog文件位置
  * --oplogLimit:重放oplog时截止到指定时间点


```sh
# 备份
mongodump --host localhost:27017 --oplog
# 恢复
mongorestore --host localhost:27017 --oplogReplay
```



分片集备份大致与复制集原理相同，不过存在以下差异:

* 应分别为每个片和config备份;
* 分片集备份不仅要考虑一-个分片内的一致性问题，还要考虑分片间的一致性问题,因此每个片要能够恢复到同- -个时间点;
  