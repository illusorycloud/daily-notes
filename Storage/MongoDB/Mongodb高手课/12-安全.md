# MongoDB安全架构

## 1.概述

MongoDB安全分为四个部分：

* 1）认证
* 2）鉴权
* 3）审计
* 4）加密



## 2. 认证

### 用户认证

| 认证方式         | 描述                                                         | 备注       |
| ---------------- | ------------------------------------------------------------ | ---------- |
| 用户名+密码      | 默认认证方式；SCRAM-SHA-1 哈希算法；用户信息存于 MongoDB 本地数据库 |            |
| 证书             | X.509 标准；服务端需要提供证书文件启动；客户端需要证书文件连接服务端；证书由内部或外部CA颁发 |            |
| LDAP外部认证     | 连接到外部 LDAP 服务器                                       | 企业版功能 |
| Kerberos外部认证 | 连接到外部 Kerberos 服务器                                   | 企业版功能 |



### 集群节点认证

**Keyfile**

将统一Keyfile 文件拷贝到不同的节点，Keyfile就是一个字符串

**X.509 ( 更加安全)**
基于证书的认证模式，推荐不同的节点使用不同的证书



## 3. 鉴权

基于角色的权限机制

* MongoDB 授权基于角色的权限控制，不同的权限的用户对数据库的操作不同

  * 例如DBA可以创建用户;
  * 应用开发者可以插入数据;
  * 报表开发者可以读取数据。

   



## 4. 加密

### 传输加密

MongoDB支持TLS/SSL来加密MongoDB的所有网络传输( 客户端应用和服务器端之间，内部复制集之间)。
TLS/SSL确保MongoDB网络传输仅可由允许的客户端读取。



### 落盘加密

可以对写入磁盘的数据进行加密，即磁盘上的所有数据都是加密的。

流程:

* 1）生成master key,用来加密每一个数据库的key。
* 2）生成每一个数据库的key,用来加密各自的数据库。
* 3）基于生成的数据库key加密各个数据库中的数据。
* 4）Key管理(只针对master key,数据库key保存在数据库内部)



### 字段级加密

加密解密过程都是在客户度，即MongoDB驱动程序。用户拿加密字段查询时，驱动程序先将明文加密后到MongoDB查询，然后将查询后的结果再进行解密返回给客户端。

* 单独文档字段通过自身密钥加密
* 数据库只看见密文
* 优势
  * 便捷:自动及透明
  * 任务分开: (简化基于服务的系统步骤，因为没有服务工程师能够看到纯文本)
  * 合规:监管“被遗忘权"
  * 快速:最小性能代偿



## 5. 审计

* 数据库等记录型系统通常使用审计监控数据库相关的一些活动，以及对一-些可疑的操作进行调查。
* 记录格式: JSON
* 记录方式:本地文件或syslog
* 记录内容:
  * Schema change ( DDL)
  * CRUD操作(DML)
  * 用户认证



* 审计日志记录到syslog
  * -- auditDestination syslog
* 审计日志记录写到指定文件
  * --auditDestination file --auditFormat JSON --auditPath /path/to/ auditLog.json
* 对删表和创建表动作进行审计日志记录
  * --auditDestination file --auditFormat JSON -- auditPath auditLog.json --auditFilter
    '{atype: {$in: ["createCollection", "dropCollection'"I}'





## 6. 最佳实践

* 1）启用身份认证
  * 启用访问控制并强制执行身份认证
  * 使用强密码
* 2）权限控制
  * 基于 Deny All 原则，不给多余权限
* 3）加密和审计
  * 启用传输加密（TLS），数据保护和活动审计
* 4）网络加固
  * 内网部署服务器
  * 设置防火墙
  * 操作系统设置
* 5）遵循安全准则
  * 遵守不同行业或地区安全标准合规性要求



